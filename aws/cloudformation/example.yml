AWSTemplateFormatVersion: "2010-09-09"
Description: "CloudFormation stack for Dockerized Next.js frontend with ALB and Auto Scaling"

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: "EC2 Key Pair for SSH access"
  
  DockerHubUsername:
    Type: String
    Description: "Docker Hub username for pulling image"
  
  DockerHubPassword:
    Type: String
    Description: "Docker Hub password or token"
  
  DockerImage:
    Type: String
    Default: "anishsabharwal/nft-marketplace:latest"
    Description: "Docker image to run on EC2"

  InstanceType:
    Type: String
    Default: "t3.micro"
    Description: "EC2 instance type"

  DesiredCapacity:
    Type: Number
    Default: 2
    Description: "Desired number of EC2 instances"

  MaxSize:
    Type: Number
    Default: 4
    Description: "Max number of EC2 instances"

  MinSize:
    Type: Number
    Default: 1
    Description: "Min number of EC2 instances"

  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: "VPC Id (default VPC recommended)"

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: "Public subnets for ALB and EC2 instances"

Resources:

  ##############################
  # Security Group
  ##############################
  FrontendSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for Next.js frontend"
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: 0.0.0.0/0

  ##############################
  # Launch Template for EC2
  ##############################
  FrontendLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: "NextjsFrontendTemplate"
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyName
        SecurityGroupIds:
          - !Ref FrontendSG
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            amazon-linux-extras install docker -y
            service docker start
            usermod -a -G docker ec2-user
            echo "${DockerHubPassword}" | docker login -u "${DockerHubUsername}" --password-stdin
            docker pull ${DockerImage}
            docker run -d -p 3000:3000 ${DockerImage}

  ##############################
  # Auto Scaling Group
  ##############################
  FrontendASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier: !Ref SubnetIds
      LaunchTemplate:
        LaunchTemplateId: !Ref FrontendLaunchTemplate
        Version: !GetAtt FrontendLaunchTemplate.LatestVersionNumber
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      TargetGroupARNs:
        - !Ref FrontendTargetGroup
      HealthCheckType: EC2
      HealthCheckGracePeriod: 60

  ##############################
  # Application Load Balancer
  ##############################
  FrontendALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: "NextjsFrontendALB"
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !Ref FrontendSG
      Scheme: internet-facing
      Type: application

  FrontendTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: "NextjsFrontendTG"
      Port: 3000
      Protocol: HTTP
      VpcId: !Ref VPCId
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckPath: "/"
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2

  FrontendALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref FrontendALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTargetGroup

Outputs:
  ALBEndpoint:
    Description: "URL of the Load Balancer"
    Value: !Sub "http://${FrontendALB.DNSName}"


# # Validate template
# aws cloudformation validate-template --template-body file://frontend-stack.yaml

# # Create stack
# aws cloudformation create-stack \
#   --stack-name nextjs-frontend \
#   --template-body file://frontend-stack.yaml \
#   --capabilities CAPABILITY_NAMED_IAM \
#   --parameters ParameterKey=KeyName,ParameterValue=your-key \
#                ParameterKey=DockerHubUsername,ParameterValue=your-username \
#                ParameterKey=DockerHubPassword,ParameterValue=your-password \
#                ParameterKey=VPCId,ParameterValue=vpc-xxxxxx \
#                ParameterKey=SubnetIds,ParameterValue="subnet-111111,subnet-222222"
